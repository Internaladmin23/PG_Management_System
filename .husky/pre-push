#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-push checks..."

# Check which files have changed
BACKEND_CHANGED=$(git diff --name-only origin/main...HEAD | grep "^backend/" || true)
APP_CHANGED=$(git diff --name-only origin/main...HEAD | grep "^app/" || true)

# Run backend tests if backend files changed
if [ -n "$BACKEND_CHANGED" ]; then
  echo "ğŸ“¦ Backend files changed, running tests..."
  cd backend
  ./gradlew test --no-daemon
  if [ $? -ne 0 ]; then
    echo "âŒ Backend tests failed!"
    exit 1
  fi
  cd ..
fi

# Run app tests if app files changed
if [ -n "$APP_CHANGED" ]; then
  echo "ğŸ“± app files changed, running tests..."
  cd app
  npm test -- --watchAll=false
  if [ $? -ne 0 ]; then
    echo "âŒ app tests failed!"
    exit 1
  fi
  cd ..
fi

echo "âœ… Pre-push checks passed!"